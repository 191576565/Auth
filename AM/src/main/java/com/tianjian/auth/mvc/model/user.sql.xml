<?xml version="1.0" encoding="UTF-8"?>

<!--  
	用户信息sql
-->
<sql-statement namespace="model.user">
	
	<!-- 分页查询用户 -->
	<sql id="paging">
		<![CDATA[ 
        	<% if(db_type == "mysql" || db_type == "postgresql"){ %>
        	
        		select * from pt_user order by ids asc limit ? offset ? 
        	
        	<% } else if(db_type == "oracle"){ %>
        	
        		select * from ( select a.*, rownum rn from (select * from pt_user) a where rownum < ? ) where rn >= ?
        	
        	<% } else if(db_type == "sqlserver"){ %>
        		
        		select top {0, number, #.#} * from pt_user where ids not in ( select top {1, number, #.#} ids from pt_user )
        		
        	<% } else if(db_type == "db2"){ %>
        		
        		select * from ( select b.*, rownumber() over() as rn from ( select * from pt_user ) as b ) as a where a.rn < ? and a.rn >= ?
        		
        	<% } %>
    	]]>
	</sql>
	
	<!-- 不规则查询：查询userinfo数据 -->
	<sql id="userinfo">
		<![CDATA[ 
          select t2.uuid as domain_uuid,
       t2.domain_id,
       t2.domain_name,
       t3.uuid as org_uuid,
       t3.org_unit_id,
       t3.org_unit_desc,
       t0.uuid as user_uuid,
       t0.user_id,
       t0.user_name,
       listagg(t1.uuid, ',') within group(order by t1.role_id) as role_uuids,
       listagg(t1.role_id, ',') within group(order by t1.role_id) as role_ids,
       listagg(t1.role_name, ',') within group(order by t1.role_id) as role_names
  from sys_user_info t0
  left join sys_role_info t1
    on instr(t0.roles, t1.uuid) > 0
  left join sys_domain_info t2
    on t0.domain_uuid = t2.uuid
  left join sys_org_info t3
    on t0.org_uuid = t3.uuid
   and t0.domain_uuid = t3.domain_uuid
 where t0.user_id = ?
 group by t2.uuid,
          t2.domain_id,
          t2.domain_name,
          t3.uuid,
          t3.org_unit_id,
          t3.org_unit_desc,
          t0.uuid,
          t0.user_id,
          t0.user_name
    	]]>
	</sql>
	

	<!-- 查询Sessionid和用户信息权限 0 测试数据 -->
	<sql id="rpmselect0">
		<![CDATA[ 

        	select * from ${table} where ${column} = ? and ${session} = ? and loggin_status = '0'
    	]]>
	</sql>
	
	<!-- 不规则查询：查询Sessionid和用户信息权限  1 用户权限 -->
	<sql id="rpmselect1">
		<![CDATA[ 
with tmp_roles as (
              select t0.user_id                                                           
              ,listagg(t1.role_id  , ',') within group(order by t1.role_id)  as role_id  
              ,listagg(t1.role_name, ',') within group(order by t1.role_id)  as role_name
                from sys_user_info     t0
              left join sys_role_info     t1  on instr(t0.roles  ,t1.uuid)>0             
              group by t0.user_id    )
    ,tmp_users  as (
              select  t2.domain_id                                                       
                     ,t2.domain_name                                                     
                     ,t3.org_unit_id                                                     
                     ,t3.org_unit_desc                                                   
                     ,t0.user_id                                                         
                     ,t0.user_name             
                     ,t4.uuid             as res_uuid                                           
                     ,t4.res_id           as res_id      
                     ,t4.res_name         as res_name   
                     ,t4.res_url          as res_url
                     ,nvl(t5.res_id,'#')  as res_up_id  
                     ,t4.res_class        as res_css    
                     ,t4.res_color        as res_color  
                     ,t4.res_icon         as res_icon   
                     ,t4.res_type         as res_type   
                     ,t4.sort_id          as res_sort_id
                   from sys_user_info     t0                                             
              left join sys_role_info     t1  on instr(t0.roles  ,t1.uuid)>0             
              left join sys_domain_info   t2  on t0.domain_uuid=t2.uuid                  
              left join sys_org_info      t3  on t0.org_uuid=t3.uuid and t0.domain_uuid=t3.domain_uuid  
              left join sys_resource_info t4  on instr(t1.resources  ,t4.uuid)>0
              left join sys_resource_info t5  on t4.res_up_uuid=t5.uuid
             where   ${column} = ? and ${session} = ? and loggin_status = '0'
              group  by
               t2.domain_id     ,t2.domain_name     ,t3.org_unit_id   ,t3.org_unit_desc ,t0.user_id  ,t0.user_name ,t4.uuid    ,t4.res_id
               ,t4.res_name     ,t4.res_url   ,nvl(t5.res_id,'#') ,t4.res_class   ,t4.res_color     ,t4.res_icon   ,t4.res_type ,t4.sort_id        )
     select tu.domain_id,            
            tu.domain_name,         
            tu.org_unit_id,         
            tu.org_unit_desc,       
            tu.user_id,             
            tu.user_name,           
            tr.role_id,             
            tr.role_name,           
            tu.res_id,              
            tu.res_name,            
            tu.res_url,             
            tu.res_up_id,           
            tu.res_css,             
            tu.res_color,           
            tu.res_icon,            
            tu.res_type             
    from tmp_users  tu 
    left join tmp_roles   tr on  tu.user_id=tr.user_id
     start with res_uuid =domain_id   connect by prior res_id =res_up_id
    order by  tu.res_sort_id
    	]]>
	</sql>
	<!-- 不规则查询：查询Sessionid和用户信息权限  2 用户数据权限  （全部）-->
	<sql id="rpmselect2">
		<![CDATA[ 
		   SELECT     DOMAIN_ID                                                                         
             ,DOMAIN_NAME                                                                   
             ,ORG_UNIT_ID                                                                   
             ,ORG_UNIT_DESC                                                                 
             ,USER_ID                                                                       
             ,USER_NAME 
             ,GROUP_ID
             ,REQ_URL
             ,CONDITION_TYPE
             ,CONDITION_CONTENT
             ,CONTENT_ORG_ID
             ,CONTENT_ORG_DESC
           FROM V_API_RPM  where  1=1  or  ( 1 = ? and 1 = ?) 
    	]]>
	</sql>
	
	<!-- 不规则查询：查询用户信息  3 用户数据权限  （登录用户）-->
	<sql id="rpmselect3">
		<![CDATA[ 
		 SELECT  T2.DOMAIN_ID
       ,T2.DOMAIN_NAME
       ,T3.ORG_UNIT_ID
       ,T3.ORG_UNIT_DESC
       ,T0.USER_ID
       ,T0.USER_NAME
      ,LISTAGG(T1.ROLE_ID  , ',') WITHIN GROUP(ORDER BY T1.ROLE_ID)  AS ROLE_IDS
      ,LISTAGG(T1.ROLE_NAME, ',') WITHIN GROUP(ORDER BY T1.ROLE_ID)  AS ROLE_NAMES
      ,T0.LOGGIN_STATUS
      ,T0.USER_SID
     FROM SYS_USER_INFO     T0
LEFT JOIN SYS_ROLE_INFO     T1  ON INSTR(T0.ROLES  ,T1.UUID)>0
LEFT JOIN SYS_DOMAIN_INFO   T2  ON T0.DOMAIN_UUID=T2.UUID
LEFT JOIN SYS_ORG_INFO      T3  ON T0.ORG_UUID=T3.UUID and t0.domain_uuid=t3.domain_uuid
WHERE   ( 1=1  or 1 = ?   ) and ${session} = ? and loggin_status = '0'
GROUP BY  t2.UUID,T2.DOMAIN_ID,T2.DOMAIN_NAME ,T3.UUID ,T3.ORG_UNIT_ID,T3.ORG_UNIT_DESC ,T0.USER_ID ,T0.USER_NAME     ,T0.LOGGIN_STATUS ,T0.USER_SID 
	  
    	]]>
	</sql>
	
	<!-- 外部系统用户登出 -->
	<sql id="uloginw">
		<![CDATA[ 
		    update ${table} set  loggin_status='1'  where ${column} = ? 
    	]]>
	</sql>
	
	<!-- 本系统用户登出 -->
	<sql id="ulogino">
		<![CDATA[ 
		    update ${table} set  loggin_status=? , user_sid = ? where ${column} = ? 
    	]]>
	</sql>
	
	<!-- 查询用户，自定义字段和值 -->
	<sql id="column">
		<![CDATA[ 
        	select * from ${table} where ${column} = ?
    	]]>
	</sql>
	
	<!-- 停用账户 -->
	<sql id="stop">
		<![CDATA[ 
        	update pt_user set stopDate = ?, errorCount = ? where ids = ?
    	]]>
	</sql>
	
	<!-- 启用停用账户 -->
	<sql id="start">
		<![CDATA[ 
        	update pt_user set stopdate = null, errorcount = 0 where ids = ?
    	]]>
	</sql>
	
	<!-- 动态SQL处理 -->
	<sql id="splitPageSelect">
		<![CDATA[ 
			select 
				u.ids, u.username, u.names, u.email, u.mobile, 
				ui.birthday, 
				d.names as deptnames
    	]]>
	</sql>
	
	<!-- 动态SQL处理 -->
	<sql id="splitPageFrom">
		<![CDATA[ 
        	from 
        		pt_user u 
				left join pt_userinfo ui on u.ids = ui.ids 
				left join pt_department d on u.departmentids = d.ids 
			
			where 1=1 
			
			<% if(!isEmpty(userClass)){ %>
					and u.userClass = #'$userClass$'#
			<% } %>
			
			<% if(!isEmpty(userName)){ %>
					and u.userName like #'%$userName$%'#
			<% } %>
			
			<% if(!isEmpty(names)){ %>
					and u.names like #'%$names$%'#
			<% } %>
			
			<% if(!isEmpty(email)){ %>
					and u.email like #'%$email$%'#
			<% } %>
			
			<% if(!isEmpty(mobile)){ %>
					and u.mobile like #'%$mobile$%'#
			<% } %>
			
			<% if(!isEmpty(idCard)){ %>
					and u.idCard like #'%$idCard$%'#
			<% } %>
			
			<% if(!isEmpty(sex)){ %>
					and ui.sex like #'%$sex$%'#
			<% } %>
			
			<% if(!isEmpty(telephone)){ %>
					and ui.telephone like #'%$telephone$%'#
			<% } %>
			
			<% if(!isEmpty(qq)){ %>
					and ui.qq like #'%$qq$%'#
			<% } %>
			
			<% if(!isEmpty(birthday)){ %>
				<% if(db_type == "mysql"){ %>
						and ui.birthday = #'$birthday$'#
						
				<% } else if(db_type == "postgresql"){ %>
						and ui.birthday = to_date(#'$birthday$'#, 'YYYY-mm-dd')
						
				<% } else if(db_type == "oracle"){ %>
						and ui.birthday = to_date(#'$birthday$'#, 'YYYY-mm-dd')
						
				<% } else if(db_type == "sqlserver"){ %>
						and ui.birthday = #'$birthday$'#
						
				<% } else if(db_type == "db2"){ %>
						and ui.birthday = #'$birthday$'#
				<% }%>
			<% } %>
    	]]>
	</sql>

</sql-statement>