<?xml version="1.0" encoding="UTF-8"?>

<!--  
	用户信息sql
-->
<sql-statement namespace="model.user">
	
	<!-- 分页查询用户 -->
	<sql id="paging">
		<![CDATA[ 
        	<% if(db_type == "mysql" || db_type == "postgresql"){ %>
        	
        		select * from pt_user order by ids asc limit ? offset ? 
        	
        	<% } else if(db_type == "oracle"){ %>
        	
        		select * from ( select a.*, rownum rn from (select * from pt_user) a where rownum < ? ) where rn >= ?
        	
        	<% } else if(db_type == "sqlserver"){ %>
        		
        		select top {0, number, #.#} * from pt_user where ids not in ( select top {1, number, #.#} ids from pt_user )
        		
        	<% } else if(db_type == "db2"){ %>
        		
        		select * from ( select b.*, rownumber() over() as rn from ( select * from pt_user ) as b ) as a where a.rn < ? and a.rn >= ?
        		
        	<% } %>
    	]]>
	</sql>
	

	<!-- 查询Sessionid和用户信息权限 0 测试数据 -->
	<sql id="rpmselect0">
		<![CDATA[ 

        	select * from ${table} where ${column} = ? and ${session} = ? and loggin_status = '0'
    	]]>
	</sql>
	
	<!-- 查询Sessionid和用户信息权限 0 用户权限 -->
	<sql id="rpmselect0">
		<![CDATA[ 
        	with TMP_ROLES as (
select T0.UUID  USER_UUID                                            
,LISTAGG(T1.ROLE_ID  , ',') WITHIN GROUP(ORDER BY T1.ROLE_ID)  AS ROLE_IDS    
,LISTAGG(T1.ROLE_NAME, ',') WITHIN GROUP(ORDER BY T1.ROLE_ID)  AS ROLE_NAMES 
  FROM SYS_USER_INFO     T0
LEFT JOIN SYS_ROLE_INFO     T1  ON INSTR(T0.ROLES  ,T1.UUID)>0                
group by T0.UUID    )
SELECT  T2.DOMAIN_ID                                                                       
       ,T2.DOMAIN_NAME                                                                      
       ,T3.ORG_UNIT_ID                                                                    
       ,T3.ORG_UNIT_DESC                                                             
       ,T0.USER_ID                                                                       
       ,T0.USER_NAME                                                            
       ,T6.ROLE_IDS                                                                       
       ,T6.ROLE_NAMES                                                            
       ,LISTAGG(T4.RES_ID         , ',') WITHIN GROUP(ORDER BY T4.RES_ID)   AS RES_IDS      
       ,LISTAGG(T4.RES_NAME       , ',') WITHIN GROUP(ORDER BY T4.RES_ID)   AS RES_NAMES     
       ,LISTAGG(nvl(T5.RES_ID,'#'), ',') WITHIN GROUP(ORDER BY T4.RES_ID)   AS RES_UP_IDS   
       ,LISTAGG(T4.RES_CLASS      , ',') WITHIN GROUP(ORDER BY T4.RES_ID)   AS RES_CSS       
       ,LISTAGG(T4.RES_COLOR      , ',') WITHIN GROUP(ORDER BY T4.RES_ID)   AS RES_COLOR     
       ,LISTAGG(T4.RES_ICON       , ',') WITHIN GROUP(ORDER BY T4.RES_ID)   AS RES_ICON      
       ,LISTAGG(T4.RES_TYPE       , ',') WITHIN GROUP(ORDER BY T4.RES_ID)   AS RES_TYPE      
     FROM SYS_USER_INFO     T0                                                              
LEFT JOIN SYS_ROLE_INFO     T1  ON INSTR(T0.ROLES  ,T1.UUID)>0                             
LEFT JOIN SYS_DOMAIN_INFO   T2  ON T0.DOMAIN_UUID=T2.UUID                                   
LEFT JOIN SYS_ORG_INFO      T3  ON T0.ORG_UUID=T3.UUID and t0.domain_uuid=t3.domain_uuid  
LEFT JOIN SYS_RESOURCE_INFO T4  ON INSTR(T1.RESOURCES  ,T4.UUID)>0
LEFT JOIN SYS_RESOURCE_INFO T5  ON T4.RES_UP_UUID=T5.UUID
LEFT JOIN TMP_ROLES         T6  ON T6.user_uuid=T0.UUID
WHERE ${column} = ? AND ${session} = ? AND LOGGIN_STATUS = '0'
 GROUP BY T2.DOMAIN_ID,T2.DOMAIN_NAME ,T3.ORG_UNIT_ID,T3.ORG_UNIT_DESC ,T0.USER_ID ,T0.USER_NAME , T6.ROLE_IDS ,T6.ROLE_NAMES
    	]]>
	</sql>
	
	<!-- 查询Sessionid和用户信息权限  1 用户权限 -->
	<sql id="rpmselect1">
		<![CDATA[ 
select  t2.domain_id     as domain_id                                                                    
       ,t2.domain_name    as domain_name                                                                 
       ,t3.org_unit_id   as org_unit_id                                                                   
       ,t3.org_unit_desc  as org_unit_desc                                                                 
       ,t0.user_id       as  user_id                                                                
       ,t0.user_name     as user_name                                                                   
       ,t1.role_id   as role_id
       ,t1.role_name  as role_name
       ,t4.res_id           as res_ids       
       ,t4.res_name         as res_names   
       ,nvl(t5.res_id,'#')  as res_up_ids   
       ,t4.res_class        as res_css      
       ,t4.res_color        as res_color    
       ,t4.res_icon         as res_icon    
       ,t4.res_type         as res_type      
     from sys_user_info     t0                                                            
left join sys_role_info     t1  on instr(t0.roles  ,t1.uuid)>0                             
left join sys_domain_info   t2  on t0.domain_uuid=t2.uuid                               
left join sys_org_info      t3  on t0.org_uuid=t3.uuid and t0.domain_uuid=t3.domain_uuid    
left join sys_resource_info t4  on instr(t1.resources  ,t4.uuid)>0
left join sys_resource_info t5  on t4.res_up_uuid=t5.uuid
where ${column} = ? and ${session} = ? and loggin_status = '0'
    	]]>
	</sql>
	
	<!-- 外部系统用户登出 -->
	<sql id="uloginw">
		<![CDATA[ 
		    update ${table} set  loggin_status='1'  where ${column} = ? and ${session} = ?
    	]]>
	</sql>
	
	<!-- 本系统用户登出 -->
	<sql id="ulogino">
		<![CDATA[ 
		    update ${table} set  loggin_status=? , user_sid = ? where ${column} = ? 
    	]]>
	</sql>
	
	<!-- 查询用户，自定义字段和值 -->
	<sql id="column">
		<![CDATA[ 
        	select * from ${table} where ${column} = ?
    	]]>
	</sql>
	
	<!-- 停用账户 -->
	<sql id="stop">
		<![CDATA[ 
        	update pt_user set stopDate = ?, errorCount = ? where ids = ?
    	]]>
	</sql>
	
	<!-- 启用停用账户 -->
	<sql id="start">
		<![CDATA[ 
        	update pt_user set stopdate = null, errorcount = 0 where ids = ?
    	]]>
	</sql>
	
	<!-- 动态SQL处理 -->
	<sql id="splitPageSelect">
		<![CDATA[ 
			select 
				u.ids, u.username, u.names, u.email, u.mobile, 
				ui.birthday, 
				d.names as deptnames
    	]]>
	</sql>
	
	<!-- 动态SQL处理 -->
	<sql id="splitPageFrom">
		<![CDATA[ 
        	from 
        		pt_user u 
				left join pt_userinfo ui on u.ids = ui.ids 
				left join pt_department d on u.departmentids = d.ids 
			
			where 1=1 
			
			<% if(!isEmpty(userClass)){ %>
					and u.userClass = #'$userClass$'#
			<% } %>
			
			<% if(!isEmpty(userName)){ %>
					and u.userName like #'%$userName$%'#
			<% } %>
			
			<% if(!isEmpty(names)){ %>
					and u.names like #'%$names$%'#
			<% } %>
			
			<% if(!isEmpty(email)){ %>
					and u.email like #'%$email$%'#
			<% } %>
			
			<% if(!isEmpty(mobile)){ %>
					and u.mobile like #'%$mobile$%'#
			<% } %>
			
			<% if(!isEmpty(idCard)){ %>
					and u.idCard like #'%$idCard$%'#
			<% } %>
			
			<% if(!isEmpty(sex)){ %>
					and ui.sex like #'%$sex$%'#
			<% } %>
			
			<% if(!isEmpty(telephone)){ %>
					and ui.telephone like #'%$telephone$%'#
			<% } %>
			
			<% if(!isEmpty(qq)){ %>
					and ui.qq like #'%$qq$%'#
			<% } %>
			
			<% if(!isEmpty(birthday)){ %>
				<% if(db_type == "mysql"){ %>
						and ui.birthday = #'$birthday$'#
						
				<% } else if(db_type == "postgresql"){ %>
						and ui.birthday = to_date(#'$birthday$'#, 'YYYY-mm-dd')
						
				<% } else if(db_type == "oracle"){ %>
						and ui.birthday = to_date(#'$birthday$'#, 'YYYY-mm-dd')
						
				<% } else if(db_type == "sqlserver"){ %>
						and ui.birthday = #'$birthday$'#
						
				<% } else if(db_type == "db2"){ %>
						and ui.birthday = #'$birthday$'#
				<% }%>
			<% } %>
    	]]>
	</sql>

</sql-statement>