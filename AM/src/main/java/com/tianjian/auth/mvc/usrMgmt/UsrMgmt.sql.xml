<?xml version="1.0" encoding="UTF-8"?>

<!-- 用户sql -->
<sql-statement namespace="tianjian.usrMgmt">

	<sql id="selectInitOrganization">
		<![CDATA[ 
        	SELECT UUID,DOMAIN_UUID,USER_ID,ORG_UUID FROM SYS_USER_INFO WHERE USER_ID=?
    	]]>
	</sql>
	<sql id="initSelect">
		<![CDATA[ 
			SELECT A.UUID,
			       A.DOMAIN_UUID,
			       A.USER_ID,
			       A.ORG_UUID,
			       A.USER_NAME,
			       A.USER_PHONE,
			       A.USER_EMAIL,
			       B.ORG_UNIT_ID,
			       B.ORG_UNIT_DESC,
			       LISTAGG(C.ROLE_ID, ',') WITHIN GROUP(ORDER BY C.ROLE_ID) AS ROLE_IDS,
			       LISTAGG(C.ROLE_NAME, ',') WITHIN GROUP(ORDER BY C.ROLE_ID) AS ROLE_NAMES
			  FROM SYS_USER_INFO A
			 INNER JOIN (SELECT T.UUID, T.DOMAIN_UUID, T.ORG_UNIT_ID, T.ORG_UNIT_DESC
			               FROM SYS_ORG_INFO T
			              START WITH T.UUID = ?
			             CONNECT BY PRIOR T.UUID = T.ORG_UP_UUID) B
			    ON A.ORG_UUID = B.UUID
			  LEFT JOIN SYS_ROLE_INFO C
			    ON INSTR(A.ROLES, C.UUID) > 0
			 WHERE A.USER_ID <> ?
			 GROUP BY A.UUID,
			          A.DOMAIN_UUID,
			          A.USER_ID,
			          A.ORG_UUID,
			          A.USER_NAME,
			       	  A.USER_PHONE,
			          A.USER_EMAIL,
			          B.ORG_UNIT_ID,
			          B.ORG_UNIT_DESC
    	]]>
	</sql>
	<sql id="selectDomain">
		<![CDATA[ 
			SELECT T.UUID,
			       T.DOMAIN_ID,
			       T.DOMAIN_NAME,
			       DECODE(T.UUID, A.DOMAIN_UUID, 'SELECTED', '') AS SELECTED
			  FROM SYS_DOMAIN_INFO T
			  LEFT JOIN SYS_USER_INFO A
			    ON A.DOMAIN_UUID = T.UUID
			   AND A.USER_ID = ?
			 START WITH T.UUID = A.DOMAIN_UUID
			CONNECT BY PRIOR T.UUID = T.DOMAIN_UP_UUID
    	]]>
	</sql>
	<sql id="checkUserId">
		<![CDATA[ 
        	SELECT UUID,DOMAIN_UUID,USER_ID,ORG_UUID FROM SYS_USER_INFO WHERE USER_ID=?
    	]]>
	</sql>
	<sql id="selectOrganization">
		<![CDATA[ 
			SELECT T.UUID,
			       T.DOMAIN_UUID,
			       T.ORG_UNIT_ID,
			       T.ORG_UNIT_DESC,
			       DECODE(T.UUID, A.ORG_UUID, 'SELECTED', '') AS SELECTED
			  FROM SYS_ORG_INFO T
			  LEFT JOIN SYS_USER_INFO A
			    ON A.ORG_UUID = T.UUID
			   AND A.USER_ID = ?
			 START WITH T.UUID = A.ORG_UUID
			CONNECT BY PRIOR T.UUID = T.ORG_UP_UUID
    	]]>
	</sql>
	<sql id="selectRole">
		<![CDATA[ 
        	SELECT uuid,ROLE_ID,ROLE_NAME FROM SYS_ROLE_INFO WHERE DOMAIN_UUID=?
    	]]>
	</sql>
	<sql id="batchDelete">
		<![CDATA[ 
        	DELETE FROM SYS_USER_INFO WHERE UUID IN (?)
    	]]>
	</sql>
	
</sql-statement>